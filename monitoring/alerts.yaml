groups:
  - name: MAS Hub Critical Alerts
    rules:
      # Application Availability
      - alert: ApplicationDown
        expr: probe_success{job="mas-hub-healthcheck"} == 0
        for: 1m
        labels:
          severity: critical
          service: mas-hub
          team: engineering
        annotations:
          summary: "MAS Hub application is down"
          description: "MAS Hub application has been unreachable for more than 1 minute. Environment: {{ $labels.environment }}"
          runbook_url: "https://docs.mas-hub.com/runbooks/application-down"

      # High Error Rate
      - alert: HighErrorRate
        expr: (sum(rate(http_requests_total{status=~"5.."}[5m])) / sum(rate(http_requests_total[5m]))) * 100 > 5
        for: 2m
        labels:
          severity: critical
          service: mas-hub
          team: engineering
        annotations:
          summary: "High error rate detected"
          description: "Error rate is above 5% ({{ $value }}%) for more than 2 minutes"
          runbook_url: "https://docs.mas-hub.com/runbooks/high-error-rate"

      # Response Time Degradation
      - alert: HighResponseTime
        expr: histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket[5m])) by (le)) > 2
        for: 3m
        labels:
          severity: warning
          service: mas-hub
          team: engineering
        annotations:
          summary: "High response time detected"
          description: "95th percentile response time is above 2 seconds ({{ $value }}s) for more than 3 minutes"
          runbook_url: "https://docs.mas-hub.com/runbooks/high-response-time"

  - name: Firebase Infrastructure
    rules:
      # Firestore Connection Issues
      - alert: FirestoreConnectionFailure
        expr: firebase_firestore_connection_failures_total > 10
        for: 1m
        labels:
          severity: critical
          service: firebase
          component: firestore
        annotations:
          summary: "Firestore connection failures detected"
          description: "{{ $value }} Firestore connection failures in the last minute"

      # Firebase Functions Cold Starts
      - alert: HighColdStarts
        expr: rate(firebase_function_cold_starts_total[5m]) > 0.5
        for: 5m
        labels:
          severity: warning
          service: firebase
          component: functions
        annotations:
          summary: "High cold start rate for Firebase Functions"
          description: "Cold start rate is {{ $value }} per second, indicating potential performance issues"

      # Firebase Functions Execution Errors
      - alert: FunctionExecutionErrors
        expr: rate(firebase_function_errors_total[5m]) > 0.1
        for: 2m
        labels:
          severity: critical
          service: firebase
          component: functions
        annotations:
          summary: "Firebase Functions execution errors"
          description: "Function error rate is {{ $value }} per second"

  - name: Business Metrics
    rules:
      # Failed Payments
      - alert: PaymentFailures
        expr: rate(payment_failures_total[5m]) > 0.05
        for: 1m
        labels:
          severity: critical
          service: mas-hub
          component: payments
          team: business
        annotations:
          summary: "High payment failure rate"
          description: "Payment failure rate is {{ $value }} per second"
          runbook_url: "https://docs.mas-hub.com/runbooks/payment-failures"

      # User Registration Issues
      - alert: RegistrationFailures
        expr: rate(user_registration_failures_total[10m]) > 0.1
        for: 2m
        labels:
          severity: warning
          service: mas-hub
          component: auth
          team: product
        annotations:
          summary: "User registration failures detected"
          description: "User registration failure rate is {{ $value }} per second"

      # Project Creation Failures
      - alert: ProjectCreationFailures
        expr: rate(project_creation_failures_total[10m]) > 0.02
        for: 5m
        labels:
          severity: warning
          service: mas-hub
          component: projects
          team: product
        annotations:
          summary: "Project creation failures"
          description: "Project creation failure rate is {{ $value }} per second"

  - name: Security Alerts
    rules:
      # Unusual Login Activity
      - alert: UnusualLoginActivity
        expr: rate(failed_login_attempts_total[5m]) > 5
        for: 1m
        labels:
          severity: warning
          service: mas-hub
          component: auth
          team: security
        annotations:
          summary: "Unusual login activity detected"
          description: "{{ $value }} failed login attempts per second"
          runbook_url: "https://docs.mas-hub.com/runbooks/security-incident"

      # Rate Limiting Triggered
      - alert: RateLimitingTriggered
        expr: rate(rate_limit_exceeded_total[5m]) > 10
        for: 2m
        labels:
          severity: warning
          service: mas-hub
          component: api
          team: engineering
        annotations:
          summary: "Rate limiting frequently triggered"
          description: "Rate limiting triggered {{ $value }} times per second"

      # Suspicious API Usage
      - alert: SuspiciousAPIUsage
        expr: rate(api_requests_total{user_agent=~".*bot.*|.*crawler.*|.*scanner.*"}[5m]) > 10
        for: 5m
        labels:
          severity: warning
          service: mas-hub
          component: api
          team: security
        annotations:
          summary: "Suspicious API usage detected"
          description: "High rate of bot/crawler requests: {{ $value }} per second"

  - name: Database Performance
    rules:
      # Firestore Read Latency
      - alert: HighFirestoreReadLatency
        expr: histogram_quantile(0.95, sum(rate(firestore_read_duration_seconds_bucket[5m])) by (le)) > 0.5
        for: 3m
        labels:
          severity: warning
          service: firebase
          component: firestore
        annotations:
          summary: "High Firestore read latency"
          description: "95th percentile read latency is {{ $value }}s"

      # Firestore Write Latency
      - alert: HighFirestoreWriteLatency
        expr: histogram_quantile(0.95, sum(rate(firestore_write_duration_seconds_bucket[5m])) by (le)) > 1
        for: 3m
        labels:
          severity: warning
          service: firebase
          component: firestore
        annotations:
          summary: "High Firestore write latency"
          description: "95th percentile write latency is {{ $value }}s"

      # Document Size Warnings
      - alert: LargeDocumentSize
        expr: firestore_document_size_bytes > 1000000
        for: 0m
        labels:
          severity: warning
          service: firebase
          component: firestore
        annotations:
          summary: "Large Firestore document detected"
          description: "Document size is {{ $value }} bytes (>1MB)"

  - name: Resource Usage
    rules:
      # Memory Usage
      - alert: HighMemoryUsage
        expr: (process_resident_memory_bytes / process_virtual_memory_max_bytes) * 100 > 80
        for: 5m
        labels:
          severity: warning
          service: mas-hub
          team: engineering
        annotations:
          summary: "High memory usage"
          description: "Memory usage is at {{ $value }}%"

      # CPU Usage
      - alert: HighCPUUsage
        expr: rate(process_cpu_seconds_total[5m]) * 100 > 80
        for: 5m
        labels:
          severity: warning
          service: mas-hub
          team: engineering
        annotations:
          summary: "High CPU usage"
          description: "CPU usage is at {{ $value }}%"

      # Firebase Function Timeouts
      - alert: FunctionTimeouts
        expr: rate(firebase_function_timeouts_total[5m]) > 0.01
        for: 2m
        labels:
          severity: warning
          service: firebase
          component: functions
        annotations:
          summary: "Firebase Function timeouts"
          description: "Function timeout rate is {{ $value }} per second"

  - name: Business KPIs
    rules:
      # Daily Active Users Drop
      - alert: DAUDrop
        expr: (mas_hub_daily_active_users offset 1d) - mas_hub_daily_active_users > 100
        for: 0m
        labels:
          severity: warning
          service: mas-hub
          team: product
        annotations:
          summary: "Significant drop in Daily Active Users"
          description: "DAU dropped by {{ $value }} users compared to yesterday"

      # Revenue Impact
      - alert: RevenueImpact
        expr: rate(successful_payments_total[1h]) < (rate(successful_payments_total[1h] offset 1d) * 0.8)
        for: 30m
        labels:
          severity: critical
          service: mas-hub
          component: payments
          team: business
        annotations:
          summary: "Significant drop in payment success rate"
          description: "Payment success rate is 20% below yesterday's rate"

      # Client Portal Usage
      - alert: LowClientPortalUsage
        expr: rate(client_portal_logins_total[1h]) < (rate(client_portal_logins_total[1h] offset 1d) * 0.5)
        for: 1h
        labels:
          severity: warning
          service: mas-hub
          component: portals
          team: product
        annotations:
          summary: "Low client portal usage"
          description: "Client portal logins are 50% below normal"

  - name: External Dependencies
    rules:
      # Stripe API Issues
      - alert: StripeAPIErrors
        expr: rate(stripe_api_errors_total[5m]) > 0.05
        for: 2m
        labels:
          severity: critical
          service: stripe
          team: engineering
        annotations:
          summary: "Stripe API errors detected"
          description: "Stripe API error rate is {{ $value }} per second"

      # Paymob API Issues
      - alert: PaymobAPIErrors
        expr: rate(paymob_api_errors_total[5m]) > 0.05
        for: 2m
        labels:
          severity: critical
          service: paymob
          team: engineering
        annotations:
          summary: "Paymob API errors detected"
          description: "Paymob API error rate is {{ $value }} per second"

      # Email Service Issues
      - alert: EmailDeliveryFailures
        expr: rate(email_delivery_failures_total[10m]) > 0.1
        for: 5m
        labels:
          severity: warning
          service: email
          team: engineering
        annotations:
          summary: "Email delivery failures"
          description: "Email delivery failure rate is {{ $value }} per second"

      # Slack Webhook Failures
      - alert: SlackWebhookFailures
        expr: rate(slack_webhook_failures_total[10m]) > 0.05
        for: 5m
        labels:
          severity: warning
          service: slack
          team: engineering
        annotations:
          summary: "Slack webhook failures"
          description: "Slack webhook failure rate is {{ $value }} per second"